@page "/contact"
@using ApiService
@using ApiService.Models
@using ApiService.Repositories
@rendermode InteractiveServer
@inject ApiService ApiService
@inject ISnackbar Snackbar

<PageTitle>Kontakt</PageTitle>

<div class="services-container">
    <h2>Kontakt</h2>

    <div class="service-back">
        <div class="team-section">
            <h3>Zespół projektowy</h3>
            <div class="team-members">
                <div class="team-member">
                    <div class="member-photo">
                        <img src="placeholder.png" alt="Kornelia Kołowska" />
                    </div>
                    <h4>Kornelia Kołowska</h4>
                    <p>Mobile Developer</p>
                    <p class="email">245845@edu.p.lodz.pl</p>
                </div>
                <div class="team-member">
                    <div class="member-photo">
                        <img src="placeholder.png" alt="Bartłomiej Mielnicki" />
                    </div>
                    <h4>Bartłomiej Mielnicki</h4>
                    <p>Mobile Developer</p>
                    <p class="email">245876@edu.p.lodz.pl</p>
                </div>
                <div class="team-member">
                    <div class="member-photo">
                        <img src="placeholder.png" alt="Jakub Borkiewicz" />
                    </div>
                    <h4>Jakub Borkiewicz</h4>
                    <p>Mobile Developer</p>
                    <p class="email">245775@edu.p.lodz.pl</p>
                </div>
                <div class="team-member">
                    <div class="member-photo">
                        <img src="placeholder.png" alt="Daniel Karolak" />
                    </div>
                    <h4>Daniel Karolak</h4>
                    <p>Frontend Developer</p>
                    <p class="email">245838@edu.p.lodz.pl</p>
                </div>
                <div class="team-member">
                    <div class="member-photo">
                        <img src="placeholder.png" alt="Oliwier Szafrański" />
                    </div>
                    <h4>Oliwier Szafrański</h4>
                    <p>Fullstack Developer</p>
                    <p class="email">245935@edu.p.lodz.pl</p>
                </div>
            </div>
        </div>

        <div class="service-tab">
            <div class="service-col">
                <h3>Formularz kontaktowy</h3>
                <h4>Imię</h4>
                <input type="text" placeholder="Podaj swoje imię" @bind="_name" />

                <h4>Email</h4>
                <input type="email" placeholder="Podaj swój adres email" @bind="_email" />

                <h4>Temat</h4>
                <input type="text" placeholder="Temat wiadomości" @bind="_subject" />
            </div>
            <div class="service-col">
                <h3>&nbsp;</h3>
                <h4>Treść wiadomości</h4>
                <textarea class="textarea" placeholder="Opisz swój problem lub pytanie..." @bind="_message"></textarea>
            </div>
        </div>

        <button @onclick="SendMessage" disabled="@_isSending">
            @if (_isSending)
            {
                <span>Wysyłanie...</span>
            }
            else
            {
                <span>Wyślij wiadomość</span>
            }
        </button>
        
        <div class="map-container">
            <h3>Nasza lokalizacja</h3>
            <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2469.869241033757!2d19.449142677061726!3d51.75371457187036!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x471a34d85d1152f3%3A0xbe75c3beee4bad56!2zUG9saXRlY2huaWthIMWBw7Nkemth!5e0!3m2!1spl!2spl!4v1746280311556!5m2!1spl!2spl" 
                   width="100%" height="600px" style="height:600px; border:0; margin-top: 20px; margin-bottom: 20px;" 
                   allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
    </div>
</div>

@code {
    private string _name = "";
    private string _email = "";
    private string _subject = "";
    private string _message = "";
    private bool _isSending = false;

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_name) || string.IsNullOrWhiteSpace(_email) ||
            string.IsNullOrWhiteSpace(_subject) || string.IsNullOrWhiteSpace(_message))
        {
            Snackbar.Add("Wypełnij wszystkie pola formularza", Severity.Warning);
            return;
        }

        if (!IsValidEmail(_email))
        {
            Snackbar.Add("Podaj prawidłowy adres email", Severity.Warning);
            return;
        }

        try
        {
            _isSending = true;

            var emailRequest = new KontaktEmailRequest
            {
                EmailOdbiorcy = "245935@edu.p.lodz.pl",
                Temat = _subject,
                Tresc = $"Imie:{_name}{Environment.NewLine}Od:{_email}{Environment.NewLine}Treść:{_message}"
            };

            var result = await ApiService.KontaktEmailRepo.KontaktEmailPost(emailRequest);

            if (result.Error == null && result.Data)
            {
                Snackbar.Add("Wiadomość została wysłana! Dziękujemy za kontakt.", Severity.Success);
                ResetForm();
            }
            else
            {
                Snackbar.Add($"Wystąpił błąd podczas wysyłania wiadomości: {result.Error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Wystąpił nieoczekiwany błąd: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSending = false;
        }
    }

    private void ResetForm()
    {
        _name = "";
        _email = "";
        _subject = "";
        _message = "";
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
}