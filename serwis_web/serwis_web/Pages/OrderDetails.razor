@page "/orders/{OrderId}"
@rendermode InteractiveServer

<PageTitle>Szczegóły zlecenia</PageTitle>

<div class="order-container">
	<div class="title-changes">
		<h2>Szczegóły zlecenia</h2>
		<div class="header-buttons">
			<button class="btn-changes" @onclick="ToggleHistoryModal">Historia zmian</button>
			@if (isAdmin)
			{
				<button class="btn-delete">Usuń zlecenie</button>
			}
		</div>
	</div>

	<div class="order-back">
		<div class="order-tab">

			@if (order == null)
			{
				<h5>Nie znaleziono zlecenia o numerze @OrderId</h5>
			}
			else
			{
				<div class="order-col">
					<div class="order-row">
						<div class="single-col">
							<h4>Numer Zlecenia</h4>
							<input type="number" placeholder="@order?.NumerZlecenia" />
						</div>
						<div class="single-col">
							<h4>Rodzaj zlecenia</h4>
							<input type="text" placeholder="@order?.Rodzaj" />
						</div>
					</div>

					<textarea placeholder="Laptop bardzo się przegrzewa i samoczynnie wyłącza po kilkunastu minutach pracy. Wentylator działa głośno, a system działa wolno. Proszę o diagnozę i naprawę." class="textarea"></textarea>

					<div class="order-row">
						<div class="single-col">
							<h4>Klient</h4>
							<input type="text" placeholder="Anna Nowak" />
						</div>
						<div class="single-col">
							<h4>Adres Email Klienta</h4>
							<input type="email" placeholder="anowak@gmail.com" />
						</div>
					</div>

					<div class="order-row">
						<div class="single-col">
							<h4>Numer Telefonu Klienta</h4>
							<input type="number" placeholder="536875432" />
						</div>
						<div class="single-col">
							<h4>Państwo</h4>
							<input type="text" placeholder="Polska" />
						</div>
					</div>

					<div class="order-row">
						<div class="single-col">
							<h4>Ulica</h4>
							<input type="text" placeholder="Radwanska" />
						</div>
						<div class="single-col">
							<h4>Numer Domu</h4>
							<input type="number" placeholder="42" />
						</div>
					</div>


					<div class="order-row">
						<div class="single-col">
							<h4>Miasto</h4>
							<input type="text" placeholder="Łódź" />
						</div>
						<div class="single-col">
							<h4>Kod pocztowy</h4>
							<input type="number" placeholder="90-012" />
						</div>
					</div>

					<div class="order-row">
						<div class="single-col">
							<h4>Planowana Data Realizacji</h4>
							<input type="date" placeholder="12.04.2025" />
						</div>
						<div class="single-col">
							<h4>Planowana Data Zakończenia</h4>
							<input type="date" placeholder="26.04.2025" />
						</div>
					</div>

					<div class="order-row">
						<div class="single-col">
							<h4>Data Rozpoczęcia Realizacji</h4>
							<input type="date" placeholder="12.04.2025" style="font-weight: bold" />
						</div>
						<div class="single-col">
							<h4>Data Zakończenia Realizacji</h4>
							<input type="date" placeholder="26.04.2025" style="font-weight: bold" />
						</div>
					</div>

				</div>
				<div class="order-col">

					<div class="order-row">
						<div class="single-col">
							<h4>Data utworzenia zlecenia</h4>
							<input type="date" placeholder="29.03.2025" />
						</div>
						<div class="single-col">
							<h4>Serwisant</h4>
							<input type="text" placeholder="Jan Kowalski" />
						</div>
					</div>


					<div class="order-row">
						<div class="single-col">
							<h4>Adres Email Serwisanta</h4>
							<input type="email" placeholder="jkowalski@gmail.com" />
						</div>
						<div class="single-col">
							<h4>Numer Telefonu Serwisanta</h4>
							<input type="number" placeholder="536875432" />
						</div>
					</div>

					<h4>Priorytet</h4>
					<input type="text" placeholder="@order?.Priorytet" />


					<h4>Metoda Płatności</h4>
					<input type="number" placeholder="Przelew krajowy" />

					<h4>Status zlecenia</h4>
					<span class="@GetStatusClass(order.Status)">@order.Status</span>

					<h4>Kwota do zapłaty</h4>
					<input type="text" placeholder="@order?.Koszt zł" style="font-weight: bold; font-size: 18px" />


					<h4>Oceń Wykonaną Usługę</h4>
					<div class="order-rate">
						<i class="fa-solid fa-star" style="color: #FEC53D"></i>
						<i class="fa-solid fa-star" style="color: #FEC53D"></i>
						<i class="fa-solid fa-star" style="color: #FEC53D"></i>
						<i class="fa-solid fa-star" style="color: #FEC53D"></i>
						<i class="fa-regular fa-star" style="color: #545353"></i>
					</div>

					<h4>Komentarz</h4>
					<input type="text" placeholder="Dodaj komentarz do wykonanej usługi" />

					@if (isAdmin)
					{
						<button>Zapisz zmiany</button>
					}
					else
					{
						<button>Dodaj komentarz</button>
					}
				</div>
			}
		</div>
	</div>
</div>

@if (showHistoryModal)
{
	<div class="modal">
		<div class="containerForm">
			<i class="fa-solid fa-times" @onclick="CloseHistoryModal"></i>
			<div class="form">
				<h2>Historia zmian</h2>
				@if (order != null)
				{
					<div class="history-list">
						@foreach (var change in orderChanges)
						{
							<div class="history-item">
								<p><strong>Data:</strong> @change.Date.ToString("dd.MM.yyyy HH:mm")</p>
								<p><strong>Użytkownik:</strong> @change.User</p>
								<p><strong>Status:</strong> @change.Status</p>
								<p><strong>Uwaga:</strong> @change.Note</p>
							</div>
						}
					</div>
				}
				else
				{
					<p>Brak historii zmian dla tego zlecenia</p>
				}

				@if (isAdmin && !addNewHistoryChangeModal)
				{
					<button class="btn-changes" @onclick="AddNewHistoryChange">Dodaj nowa zmiane</button>
				}

				@if (isAdmin && addNewHistoryChangeModal)
				{
					<div class="add-new-change">
						<h4>Status</h4>
						<select>
							<option>Nowe</option>
							<option>Oczekujące</option>
							<option>Realizacja</option>
							<option>Zakończone</option>
							<option>Anulowane</option>
						</select>

						<h4>Komentarz</h4>
						<input type="text" placeholder="Uwaga" />

						<button>Dodaj</button>
					</div>
				}
			</div>
		</div>
	</div>
}


@code {
	[Parameter]
	public String OrderId { get; set; }

	private Boolean isAdmin = true;
	private bool showHistoryModal = false;
	private bool addNewHistoryChangeModal = false;

	private class Order
	{
		public int NumerZlecenia { get; set; }
		public string Rodzaj { get; set; }
		public DateTime DataUtworzenia { get; set; }
		public DateTime DataWykonania { get; set; }
		public double Koszt { get; set; }
		public string Status { get; set; }
		public string Priorytet { get; set; }
	}

	private class ChangeHistory
	{
		public DateTime Date { get; set; }
		public string User { get; set; }
		public string Status { get; set; }
		public string Note { get; set; }
	}

	private List<ChangeHistory> orderChanges = new List<ChangeHistory>();

	private List<Order> orders = new List<Order>
	{
		new Order
		{
			NumerZlecenia = 0,
			Rodzaj = "Instalacja",
			DataUtworzenia = new DateTime(2025, 3, 14),
			DataWykonania = new DateTime(2025, 3, 28),
			Koszt = 300,
			Status = "Zakończone",
			Priorytet = "Wysoki"
		},
		new Order
		{
			NumerZlecenia = 1,
			Rodzaj = "Instalacja",
			DataUtworzenia = new DateTime(2025, 3, 14),
			DataWykonania = new DateTime(2025, 3, 28),
			Koszt = 300,
			Status = "Zakończone",
			Priorytet = "Wysoki"
		},
		new Order
		{
			NumerZlecenia = 2,
			Rodzaj = "Naprawa",
			DataUtworzenia = new DateTime(2025, 3, 20),
			DataWykonania = new DateTime(2025, 4, 5),
			Koszt = 450,
			Status = "Realizacja",
			Priorytet = "Wysoki"
		},
		new Order
		{
			NumerZlecenia = 3,
			Rodzaj = "Przegląd",
			DataUtworzenia = new DateTime(2025, 4, 1),
			DataWykonania = new DateTime(2025, 4, 15),
			Koszt = 0,
			Status = "Nowe",
			Priorytet = "Normalny"
		},
		new Order
		{
			NumerZlecenia = 4,
			Rodzaj = "Konfiguracja",
			DataUtworzenia = new DateTime(2025, 4, 10),
			DataWykonania = new DateTime(2025, 4, 20),
			Koszt = 250,
			Status = "Oczekujące",
			Priorytet = "Niski"
		},
		new Order
		{
			NumerZlecenia = 5,
			Rodzaj = "Wymiana",
			DataUtworzenia = new DateTime(2025, 4, 10),
			DataWykonania = new DateTime(2025, 4, 30),
			Koszt = 800,
			Status = "Realizacja",
			Priorytet = "Wysoki"
		},
		new Order
		{
			NumerZlecenia = 6,
			Rodzaj = "Konserwacja",
			DataUtworzenia = new DateTime(2025, 3, 28),
			DataWykonania = new DateTime(2025, 4, 12),
			Koszt = 150,
			Status = "Zakończone",
			Priorytet = "Normalny"
		},
		new Order
		{
			NumerZlecenia = 7,
			Rodzaj = "Diagnostyka",
			DataUtworzenia = new DateTime(2025, 3, 15),
			DataWykonania = new DateTime(2025, 3, 20),
			Koszt = 0,
			Status = "Anulowane",
			Priorytet = "Niski"
		},
		new Order
		{
			NumerZlecenia = 8,
			Rodzaj = "Modernizacja",
			DataUtworzenia = new DateTime(2025, 4, 5),
			DataWykonania = new DateTime(2025, 5, 1),
			Koszt = 1200,
			Status = "Oczekujące",
			Priorytet = "Wysoki"
		}
	};
	private Order order;

	protected override void OnParametersSet()
	{
		if (int.TryParse(OrderId, out int parsedId))
		{
			order = orders.FirstOrDefault(o => o.NumerZlecenia == parsedId);
			if (order != null)
			{
				GenerateSampleHistory(parsedId);
			}
		}
	}

	private void GenerateSampleHistory(int orderId)
	{
		orderChanges = new List<ChangeHistory>
		{
			new ChangeHistory
			{
				Date = DateTime.Now.AddDays(-10),
				User = "Jan Kowalski",
				Status = "Nowe",
				Note = "Utworzono zlecenie"
			},
			new ChangeHistory
			{
				Date = DateTime.Now.AddDays(-5),
				User = "Jan Kowalski",
				Status = "Oczekujące",
				Note = "Oczekuje na realizacje"
			},
			new ChangeHistory
			{
				Date = DateTime.Now.AddDays(-2),
				User = "Anna Nowak",
				Status = "Realizacja",
				Note = "Przyjeto do realizacji lorem lorem lorem lorem"

			}
		};
	}

	private string GetStatusClass(string status)
	{
		return status switch
		{
			"Zakończone" => "status-finished",
			"Realizacja" => "status-realization",
			"Anulowane" => "status-canceled",
			"Oczekujące" => "status-waiting",
			"Nowe" => "status-new",
			_ => ""
		};
	}

	private void ToggleHistoryModal()
	{
		showHistoryModal = true;
	}

	private void CloseHistoryModal()
	{
		showHistoryModal = false;
		addNewHistoryChangeModal = false;
	}

	private void AddNewHistoryChange()
	{
		addNewHistoryChangeModal = true;
	}
}