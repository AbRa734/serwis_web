@page "/orders/{OrderId:int}"
@using serwis_web.Components
@inject ApiService ApiService
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using ApiService
@using ApiService.Models
@using ApiService.Repositories
@using Console = System.Console
@inject IDialogService DialogService
@using DialogService = MudBlazor.DialogService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size

<PageTitle>Szczegóły zlecenia</PageTitle>

<style>
    .order-container {
        display: flex;
        flex-direction: column;
        gap: 23px;
        padding: 0;
        margin: 0;
        padding-left: 5px;
        padding-right: 20px;
    }

    .title-changes {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0;
        margin: 0;
        padding-right: 40px;
    }

    .title-changes h2 {
        font-size: 30px;
        font-weight: 600;
        margin: 0;
        padding: 0;
    }

    .header-buttons {
        display: flex;
        align-items: center;
        gap: 25px;
    }

    .order-back {
        display: flex;
        flex-direction: column;
        gap: 25px;
        width: 100%;
        padding: 30px;
        background-color: #FFFFFF;
        border-radius: 10px;
        box-shadow: 0 1px 1px 0 rgba(0, 0, 0, 0.1), 0 1px 4px 0 rgba(0, 0, 0, 0.1);
        margin: 0;
    }

    .order-tab {
        display: flex;
        width: 100%;
        gap: 100px;
        padding: 0;
        margin: 0;
    }

    .order-col {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .order-col h4 {
        font-size: 16px;
        font-weight: 500;
        padding: 0;
        margin: 0;
        color: #606060;
    }

    .order-row {
        display: flex;
        align-items: center;
        gap: 40px;
        width: 100%;
    }

    .single-col {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }

    .textarea, .form-input, select, option {
        background-color: #F5F6FA;
        border: solid 1px #D5D5D5;
        width: 100%;
        padding: 15px;
        border-radius: 5px;
        color: #A6A6A6;
        font-size: 14px;
    }

    .textarea {
        height: 145px;
        margin-top: 5px;
        margin-bottom: 12px;
    }

    .form-input, select, option {
        height: 50px;
        margin-bottom: 10px;
    }

    button {
        background-color: #4880FF;
        border: none;
        border-radius: 10px;
        padding: 15px;
        color: #FFFFFF;
        font-size: 16px;
        transition: all 0.3s ease-in-out;
        cursor: pointer;
        margin-top: 25px;
    }

    button:hover {
        background-color: #336ff5;
    }

    .btn-changes, .btn-delete {
        padding: 15px 50px;
        margin: 0;
    }

    .btn-delete {
        background-color: #f14c3c;
    }

    .btn-delete:hover {
        background-color: #d12413;
    }

    .order-rate {
        display: flex;
        align-items: center;
        gap: 20px;
        height: 52px;
    }

    i {
        font-size: 30px;
        cursor: pointer;
    }

    .status-finished {
        background-color: #ccf0eb;
        color: #00b69b;
        border: none;
    }

    .status-realization {
        background-color: #e0d4fc;
        color: #6226ef;
        border: none;
    }

    .status-canceled {
        background-color: #fcd7d4;
        color: #ef3826;
        border: none;
    }

    .status-waiting {
        background-color: #ffeddd;
        color: #ffa756;
        border: none;
    }

    .status-new {
        background-color: #f1d4ff;
        color: #ba29ff;
        border: none;
    }


    @@media (max-width: 1536px) {
    .order-container {
        gap: 30px;
        padding-right: 15px;
    }

    .order-row {
        gap: 40px;
    }

    .order-back {
        padding: 30px;
    }

    .order-tab {
        flex-direction: column;
        gap: 10px;
    }

    .textarea, .form-input, select {
        margin-bottom: 25px;
    }

    .order-rate {
        height: 60px;
    }

    button {
        padding: 15px;
        margin-top: 10px;
    }

    i {
        font-size: 34px;
    }

    .textarea {
        height: 220px;
        margin-top: 5px;
    }
    }

    @@media (max-width: 1280px) {
        .title-changes {
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
            padding-right: 0;
        }

        .header-buttons 
        {
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
        }

        .btn-changes, .btn-delete 
        {
            padding: 12px 50px;
            width: 100%;
        }
    }


    @@media (max-width: 1024px) {
        .order-row {
            flex-direction: column;
            gap: 5px;
        }
    }


    @@media (max-width: 768px) {
        .order-container {
            padding-right: 5px;
            padding-top: 10px;
        }
    }

    @@media (max-width: 640px) {
        .order-rate {
            gap: 14px;
        }
    }

    .comments-section {
        max-height: 300px;
        overflow-y: auto;
        border-radius: 8px;
        background-color: #f9f9f9;
        padding: 10px;
        margin-bottom: 20px;
    }

    .comment {
        background-color: white;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .comment-content p {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 14px;
        line-height: 1.4;
    }

    .comment-meta {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #777;
    }

    .services-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .service-item {
        background-color: #f0f7ff;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .service-name {
        font-weight: bold;
        font-size: 16px;
        margin: 0 0 5px 0;
    }

    .service-desc {
        color: #555;
        font-size: 14px;
        margin: 0 0 5px 0;
    }

    .service-type {
        color: #777;
        font-size: 13px;
        margin: 0;
    }
</style>

<div class="order-container">
    <div class="title-changes">
        <h2>Szczegóły zlecenia</h2>
        <div class="header-buttons">
            <button @onclick="OpenHistoryDialog" class="btn-changes">Historia zmian</button>
            @if (GetUserRole() == "Administrator")
            {
                <button @onclick="DeleteOrder" class="btn-delete">Usuń zlecenie</button>
            }
        </div>
    </div>


    <EditForm Model="@_orderDataModel" OnValidSubmit="SaveOrderData" class="order-back">
    <DataAnnotationsValidator />
    <ValidationSummary />
    
    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Style="align-items: center; justify-content: center; display: flex; margin: 0 auto;"/>
    }
    else
    {
        <div class="order-tab">
        <div class="order-col">

            <div class="order-row">
                <div class="single-col">
                    <h4>Numer zlecenia</h4>
                    <InputNumber @bind-Value="_orderDataModel.ZamowienieId" placeholder="Id zamówienia" class="form-input" readonly />
                </div>
                <div class="single-col">
                    <h4>Rodzaj zlecenia</h4>
                    <select @bind="_orderDataModel.SerwisId">
                        @foreach (var serwis in _serwisy)
                        {
                            <option value="@serwis.TypSerwisuId">@serwis.Nazwa</option>
                        }
                    </select>
                </div>
            </div>

            <div class="order-row">
                <div class="single-col">
                    <h4>Data utworzenia zlecenia</h4>
                    <InputDate @bind-Value="_orderDataModel.DataDodania" placeholder="Data utworzenia zlecenia" class="form-input" readonly />
                </div>
                <div class="single-col">
                    <h4>Data aktualizacji</h4>
                    <InputDate @bind-Value="_orderDataModel.DataAktualizacji" placeholder="Data aktualizacji" class="form-input" readonly />
                </div>
            </div>

            <h4>Opis zlecenia</h4>
            <Textarea @bind-Value="_orderDataModel.Opis" placeholder="Opis zlecenia" class="textarea" required/>

            <div class="order-row">
                <div class="single-col">
                    <h4>Imie klienta</h4>
                    <InputText @bind-Value="_orderDataModel.ImieKlienta" placeholder="Imie" class="form-input" required />
                </div>
                <div class="single-col">
                    <h4>Nazwisko klienta</h4>
                    <InputText @bind-Value="_orderDataModel.NazwiskoKlienta" placeholder="Nazwisko" class="form-input" required />
                </div>
            </div>

            <div class="order-row">
                <div class="single-col">
                    <h4>Numer telefonu klienta</h4>
                    <InputText @bind-Value="_orderDataModel.NumerTelefonuKlienta" placeholder="NumerTelefonu" class="form-input" required />
                </div>
                <div class="single-col">
                    <h4>Adres email klienta</h4>
                    <InputText @bind-Value="_orderDataModel.EmailKlienta" placeholder="Email" class="form-input" required />
                </div>
            </div>

            <h4>Państwo</h4>
            <InputText @bind-Value="_orderDataModel.Kraj" placeholder="Państwo" class="form-input" required />

            <div class="order-row">
                <div class="single-col">
                    <h4>Ulica</h4>
                    <InputText @bind-Value="_orderDataModel.Ulica" placeholder="Ulica" class="form-input" required />

                </div>
                <div class="single-col">
                    <h4>Numer domu</h4>
                    <InputNumber @bind-Value="_orderDataModel.NumerDomu" placeholder="Numer domu" class="form-input" required />
                </div>
            </div>

            <div class="order-row">
                <div class="single-col">
                    <h4>Miasto</h4>
                    <InputText @bind-Value="_orderDataModel.Miasto" placeholder="Miasto" class="form-input" required />
                </div>
                <div class="single-col">
                    <h4>Kod pocztowy</h4>
                    <InputText @bind-Value="_orderDataModel.KodPocztowy" placeholder="Kod pocztowy" class="form-input" required />
                </div>
            </div>
        </div>

        <div class="order-col">

            <div class="order-row">
                <div class="single-col">
                    <h4>Planowana Data Realizacji Od</h4>
                    <InputDate @bind-Value="_orderDataModel.PlanowanaDataRealizacjiOd" placeholder="Data" class="form-input" readonly />
                </div>
                <div class="single-col">
                    <h4>Planowana Data Realizacji Do</h4>
                    <InputDate @bind-Value="_orderDataModel.PlanowanaDataRealizacjiDo" placeholder="Data" class="form-input" readonly />
                </div>
            </div>

            <div class="order-row">
                <div class="single-col">
                    <h4>Data Rozpoczęcia Realizacji</h4>
                    <InputDate @bind-Value="_orderDataModel.ZrealizowanaDataRealizacjiOd" placeholder="Data" class="form-input" style="font-weight: bold" />

                </div>
                <div class="single-col">
                    <h4>Data Zakończenia Realizacji</h4>
                    <InputDate @bind-Value="_orderDataModel.ZrealizowanaDataRealizacjiDo" placeholder="Data" class="form-input" style="font-weight: bold" />
                </div>
            </div>

            <h4>Serwisant</h4>
            <select value="@_orderDataModel.SerwisantId" @onchange="HandleSerwisantChange">
                @foreach (var serwisant in _serwisanci)
                {
                    <option value="@serwisant.SerwisantId">@serwisant.Uzytkownik.Imie @serwisant.Uzytkownik.Nazwisko</option>
                }
            </select>


            <div class="order-row"> 
                <div class="single-col"> 
                    <h4>Adres Email Serwisanta</h4>
                    <InputText @bind-Value="_orderDataModel.EmailSerwisanta" placeholder="Email" class="form-input" required />
                </div> 
                <div class="single-col">
                    <h4>Numer Telefonu Serwisanta</h4>
                    <InputText @bind-Value="_orderDataModel.NumerTelefonuSerwisanta" placeholder="Numer telefonu" class="form-input" required />
                </div>
            </div>

            <h4>Priorytet</h4>
            <select @bind="_orderDataModel.PriorytetId">
                @foreach (var priorytet in _priorytety)
                {
                    <option value="@priorytet.PriorytetId">@priorytet.Nazwa</option>
                }
            </select>

            <h4>Metoda Płatności</h4>
            <select @bind="_orderDataModel.MetodaPlatnosciId">
                @foreach (var platnosc in _platnosci)
                {
                    <option value="@platnosc.MetodaPlatnosciId">@platnosc.Nazwa</option>
                }
            </select>

            <h4>Status zlecenia</h4>
            <select @bind="_orderDataModel.StatusId" class="@GetStatusClass(GetSelectedStatusName())">
                @foreach (var status in _statusy)
                {
                    <option value="@status.StatusId">@status.Nazwa</option>
                }
            </select>

            <h4>Kwota do zapłaty</h4>
            <InputNumber @bind-Value="_orderDataModel.Koszt100" placeholder="Koszt (zł)" class="form-input" />

            <StripePay />

            @if (_komentarze?.Any() == true)
            {
                <h4>Komentarze</h4>
                <div class="comments-section">
                    @foreach (var comment in _komentarze)
                    {
                        <div class="comment">
                            <div class="comment-content">
                                <p>@comment.Tresc</p>
                                <div class="comment-meta">
                                    <span class="comment-date">@FormatDate(comment.DataDodania)</span>
                                    <span class="comment-user">@comment.Uzytkownik?.Imie @comment.Uzytkownik?.Nazwisko</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }

            @if (GetUserRole() == "Serwisant" || GetUserRole() == "Administrator")
            {
                <button type="submit">Zapisz zmiany</button>
            }
            else
            {
                <button >Dodaj komentarz</button>
            }

        </div>

    </div>
    }


    </EditForm>
    
    
</div>


@code {
    [Parameter] public int OrderId { get; set; }

    private OrderDataModel _orderDataModel = new();
    private Zamowienie? _order;
    private List<DicTypSerwisu> _serwisy = new();
    private List<Serwisant> _serwisanci = new();
    private bool _isLoading = true;
    private List<Log> orderLogs = new List<Log>();
    public Uzytkownik? _uzytkownikKlient;
    public Uzytkownik? _uzytkownikZalogowany;
    private List<DicPriorytet> _priorytety = new();
    private List<DicMetodaPlatnosci> _platnosci = new();
    private List<DicStatus> _statusy = new();
    private ICollection<Komentarz> _komentarze;

    public NumerTelefonu? _currentPhoneKlient;
    public AdresEmail? _currentEmailKlient;

    public NumerTelefonu? _currentPhoneSerwisant;
    public AdresEmail? _currentEmailSerwisantt;

    
    private string? _message;
    private string _messageClass = "success-message";

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        try
        {
            await LoadUserData();
            await LoadOrderData();
            await LoadOrderLogs();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            throw;
        }
        finally
        {
            _isLoading = false;
        }
        
    }

    private async Task LoadUserData()
    {
        try
        {
            _uzytkownikZalogowany = await ApiService.GetUzytkownik();
        }
        catch (Exception ex)
        {
            ShowError("Błąd podczas ładowania danych użytkownika: " + ex.Message);
            return;
        }
    }

    private async Task LoadOrderData()
    {
        try
        {
            var orderResult = await ApiService.ZamowieniaRepo.ZamowienieGet(OrderId);

            if (orderResult.Error != null)
            {
                ShowError("Błąd podczas ładowania danych zlecenia: " + orderResult.Error);
                return;
            }

            _order = orderResult.Data;

            if (_order == null)
            {
                ShowError("Nie znaleziono zlecenia");
                return;
            }

            if (_order.AdresEmailId > 0)
            {
                var emailResult = await ApiService.AdresyEmailRepo.AdresEmailGet(_order.AdresEmail.AdresEmailId);
                _currentEmailKlient = emailResult.Data;
            }

            if (_order.NumerTelefonuId.HasValue && _order.NumerTelefonuId.Value > 0)
            {
                var phoneResult = await ApiService.NumeryTelefonuRepo.NumerTelefonuGet(_order.NumerTelefonuId.Value);
                _currentPhoneKlient = phoneResult.Data;
            }

            if (_order.Serwisant.Uzytkownik.AdresEmailId > 0)
            {
                var emailResult = await ApiService.AdresyEmailRepo.AdresEmailGet(_order.Serwisant.Uzytkownik.AdresEmailId);
                _currentEmailSerwisantt = emailResult.Data;
            }

            if (_order.Serwisant.Uzytkownik.NumerTelefonuId.HasValue && _order.Serwisant.Uzytkownik.NumerTelefonuId.Value > 0)
            {
                var phoneResult = await ApiService.NumeryTelefonuRepo.NumerTelefonuGet(_order.Serwisant.Uzytkownik.NumerTelefonuId.Value);
                _currentPhoneSerwisant = phoneResult.Data;
            }
            
            if (_order?.Klient?.Uzytkownik?.UzytkownikId > 0)
            {
                var userResult = await ApiService.UzytkownicyRepo.UzytkownikGet(_order.Klient.Uzytkownik.UzytkownikId);
                _uzytkownikKlient = userResult.Data;
            }
            
            _orderDataModel.ZamowienieId = _order.ZamowienieId;
            _orderDataModel.SerwisantId = _order.SerwisantId;
            
            if (_orderDataModel.SerwisantId.HasValue)
            {
                await UpdateSerwisantContactInfo(_orderDataModel.SerwisantId.Value);
            }
            
            _orderDataModel.Opis = _order.Opis;

            _orderDataModel.KlientId = _order.KlientId;
            _orderDataModel.AdresEmailId = _order.AdresEmailId;
            _orderDataModel.NumerTelefonuId = _order.NumerTelefonuId;
            _orderDataModel.AdresId = _order.AdresId;
            _orderDataModel.SerwisId = _order.Serwis.SerwisId;
            _orderDataModel.PriorytetId = _order.PriorytetId;
            _orderDataModel.MetodaPlatnosciId = _order.MetodaPlatnosciId;
            _orderDataModel.Koszt100 = _order.Koszt100;
            _orderDataModel.StatusId = _order.StatusId;
            
            _orderDataModel.DataDodania = _order.DataDodania;
            _orderDataModel.DataAktualizacji = _order.DataAktualizacji;
            _orderDataModel.PlanowanaDataRealizacjiOd = _order.PlanowanaDataRealizacjiOd;
            _orderDataModel.PlanowanaDataRealizacjiDo = _order.PlanowanaDataRealizacjiDo;
            _orderDataModel.ZrealizowanaDataRealizacjiOd = _order.ZrealizowanaDataRealizacjiOd;
            _orderDataModel.ZrealizowanaDataRealizacjiDo = _order.ZrealizowanaDataRealizacjiDo;


            _orderDataModel.EmailKlienta = _currentEmailKlient?.Email;
            _orderDataModel.NumerTelefonuKlienta = _currentPhoneKlient?.Numer;

            _orderDataModel.EmailSerwisanta = _currentEmailSerwisantt?.Email;
            _orderDataModel.NumerTelefonuSerwisanta = _currentPhoneSerwisant?.Numer;


            _orderDataModel.Ulica = _order.Adres?.Ulica;
            _orderDataModel.NumerDomu = _order.Adres?.NumerDomu ?? 0;
            _orderDataModel.NumerMieszkania = _order.Adres?.NumerMieszkania ?? 0;
            _orderDataModel.KodPocztowy = _order.Adres?.KodPocztowy;
            _orderDataModel.Miasto = _order.Adres?.Miasto;
            _orderDataModel.Kraj = _order.Adres?.Kraj;

            _orderDataModel.ImieKlienta = _order.Klient.Uzytkownik.Imie;
            _orderDataModel.NazwiskoKlienta = _order.Klient.Uzytkownik.Nazwisko;


            var serviceResult = await ApiService.TypySerwisuRepo.TypySerwisuGet();
            if (serviceResult.Data != null)
            {
                _serwisy = serviceResult.Data;
            }

            var serwisantResult = await ApiService.SerwisanciRepo.SerwisanciGet();
            if (serwisantResult.Data != null)
            {
                _serwisanci = serwisantResult.Data;
            }

            var priorytetsResult = await ApiService.PriotytetyRepo.PriotytetyGet();
            if (priorytetsResult.Data != null)
            {
                _priorytety = priorytetsResult.Data;
            }

            var paymentsResult = await ApiService.MetodyPlatnosciRepo.MetodyPlatnosciGet();
            if (paymentsResult.Data != null)
            {
                _platnosci = paymentsResult.Data;
            }

            var statusResult = await ApiService.StatusyRepo.StatusyGet();
            if (statusResult.Data != null)
            {
                _statusy = statusResult.Data;
            }

            _komentarze = _order.Komentarze;
            _orderDataModel.Status = _order.Status;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Wystąpił błąd: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task HandleSerwisantChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int serwisantId))
        {
            _orderDataModel.SerwisantId = serwisantId;
        
            await UpdateSerwisantContactInfo(serwisantId);
        }
    }

    private async Task UpdateSerwisantContactInfo(int serwisantId)
    {
        try
        {
            var selectedSerwisant = _serwisanci.FirstOrDefault(s => s.SerwisantId == serwisantId);
        
            if (selectedSerwisant != null)
            {
                var userResult = await ApiService.UzytkownicyRepo.UzytkownikGet(selectedSerwisant.Uzytkownik.UzytkownikId);
            
                if (userResult.Data != null)
                {
                    var user = userResult.Data;
                
                    if (user.AdresEmailId > 0)
                    {
                        var emailResult = await ApiService.AdresyEmailRepo.AdresEmailGet(user.AdresEmailId);
                        if (emailResult.Data != null)
                        {
                            _orderDataModel.EmailSerwisanta = emailResult.Data.Email;
                        }
                    }
                
                    if (user.NumerTelefonuId.HasValue && user.NumerTelefonuId.Value > 0)
                    {
                        var phoneResult = await ApiService.NumeryTelefonuRepo.NumerTelefonuGet(user.NumerTelefonuId.Value);
                        if (phoneResult.Data != null)
                        {
                            _orderDataModel.NumerTelefonuSerwisanta = phoneResult.Data.Numer;
                        }
                    }
                
                    StateHasChanged(); 
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd podczas pobierania danych serwisanta: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadOrderLogs()
    {
        try
        {
            var logsResult = await ApiService.LogiRepo.LogiGet();

            if (logsResult.Data != null)
            {
                orderLogs = logsResult.Data
                    .Where(log => log.ZamowienieId == OrderId)
                    .OrderByDescending(log => log.DataDodania)
                    .ToList();
            }
            else
            {
                Snackbar.Add($"Błąd pobierania historii: {logsResult.Error}", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd podczas pobierania historii: {ex.Message}", Severity.Warning);
        }
    }
    private async Task OpenHistoryDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var convertedChanges = orderLogs.Select(log => new HistoryDialog.DefaultChangeHistory
            {
                Date = log.DataDodania,
                User = GetUserFromLog(log),
                Status = log.Status?.Nazwa ?? "Aktualizacja",
                Note = log.Komentarz ?? "Zmieniono status zlecenia"
            }).ToList<HistoryDialog.IChangeHistory>();

        if (!convertedChanges.Any())
        {
            convertedChanges.Add(new HistoryDialog.DefaultChangeHistory
            {
                Date = _orderDataModel.DataDodania,
                User = "System",
                Status = _orderDataModel.Status?.Nazwa ?? "Nowe",
                Note = "Utworzono zlecenie"
            });
        }

        var dialog = await DialogService.ShowAsync<HistoryDialog>("Historia zmian", new DialogParameters
            {
                ["OrderChanges"] = convertedChanges,
                ["IsAdmin"] = true,
            }, options);
        var result = await dialog.Result;
    }

    private string GetUserFromLog(Log log)
    {
        return "Administrator systemu";
    }

    private async Task AddComment()
    {
        var parameters = new DialogParameters
            {
                ["Title"] = "Dodaj komentarz do zlecenia"
            };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<CommentDialog>("Dodaj komentarz", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string commentText && !string.IsNullOrWhiteSpace(commentText))
        {
            try
            {
                var logDto = new LogDto
                {
                    ZamowienieId = OrderId,
                    StatusId = _orderDataModel.StatusId, // Maintain current status
                    Komentarz = commentText
                };

                var logResult = await ApiService.LogiRepo.LogPost(logDto);

                if (logResult.Data != null)
                {
                    Snackbar.Add("Dodano komentarz", Severity.Success);

                    await LoadOrderData();
                }
                else
                {
                    Snackbar.Add($"Błąd: {logResult.Error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Wystąpił błąd: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteOrder()
    {
        bool confirmed = await DialogService.ShowMessageBox(
            "Potwierdzenie",
            "Czy na pewno chcesz usunąć to zlecenie?",
            yesText: "Tak",
            noText: "Nie") ?? false;

        if (confirmed)
        {
            var result = await ApiService.ZamowieniaRepo.ZamowienieDelete(OrderId);

            if (result.Data)
            {
                Snackbar.Add("Zlecenie zostało usunięte", Severity.Success);
                NavigationManager.NavigateTo("/orders");
            }
            else
            {
                Snackbar.Add($"Błąd podczas usuwania: {result.Error}", Severity.Error);
            }
        }
    }


    private async Task SaveOrderData()
    {
        try
        {
            int adresEmailId = _orderDataModel.AdresEmailId ?? 0;

            if (!string.IsNullOrWhiteSpace(_orderDataModel.EmailKlienta))
            {
                var emailDto = new AdresEmailDto { Email = _orderDataModel.EmailKlienta };

                var emailResult = adresEmailId > 0
                    ? await ApiService.AdresyEmailRepo.AdresEmailPut(adresEmailId, emailDto)
                    : await ApiService.AdresyEmailRepo.AdresEmailPost(emailDto);

                if (emailResult.Error != null)
                {
                    ShowError("Błąd podczas zapisywania adresu email: " + emailResult.Error);
                    return;
                }

                adresEmailId = emailResult.Data?.AdresEmailId ?? 0;
            }

            int? numerTelefonuId = _orderDataModel.NumerTelefonuId;

            if (!string.IsNullOrWhiteSpace(_orderDataModel.NumerTelefonuKlienta))
            {
                var phoneDto = new NumerTelefonuDto { Numer = _orderDataModel.NumerTelefonuKlienta };

                var phoneResult = numerTelefonuId.HasValue && numerTelefonuId.Value > 0
                    ? await ApiService.NumeryTelefonuRepo.NumerTelefonuPut(numerTelefonuId.Value, phoneDto)
                    : await ApiService.NumeryTelefonuRepo.NumerTelefonuPost(phoneDto);

                if (phoneResult.Error != null)
                {
                    ShowError("Błąd podczas zapisywania numeru telefonu: " + phoneResult.Error);
                    return;
                }

                numerTelefonuId = phoneResult.Data?.NumerTelefonuId;
            }
            
            int? addressId = null;
            if (!string.IsNullOrWhiteSpace(_orderDataModel.Ulica) || !string.IsNullOrWhiteSpace(_orderDataModel.Miasto))
            {
                var adresResult = await ApiService.AdresyRepo.AdresPost(new AdresDto
                {
                    Kraj = _orderDataModel.Kraj,
                    Ulica = _orderDataModel.Ulica,
                    NumerDomu = _orderDataModel.NumerDomu,
                    NumerMieszkania = _orderDataModel.NumerMieszkania,
                    Miasto = _orderDataModel.Miasto,
                    KodPocztowy = _orderDataModel.KodPocztowy
                });

                if (adresResult.Error != null || adresResult.Data == null)
                {
                    ShowError("Błąd podczas zapisywania adresu: " + adresResult.Error);
                    return;
                }

                addressId = adresResult.Data.AdresId;
            }
            
            
            if (!string.IsNullOrWhiteSpace(_orderDataModel.ImieKlienta) && !string.IsNullOrWhiteSpace(_orderDataModel.NazwiskoKlienta))
            {
                var userDto = new UzytkownikDto
                {
                    RolaUzytkownikaId = _uzytkownikKlient.RolaUzytkownika.RolaUzytkownikaId,
                    Imie = _orderDataModel.ImieKlienta,
                    Nazwisko = _orderDataModel.NazwiskoKlienta,
                    AdresEmailId = _uzytkownikKlient.AdresEmailId,
                    NumerTelefonuId = _uzytkownikKlient.NumerTelefonuId,
                    CzyAktywny = _uzytkownikKlient.CzyAktywny,
                    AdresId = _uzytkownikKlient.Adres.AdresId,
                };

                var userResult = await ApiService.UzytkownicyRepo.UzytkownikPut(_uzytkownikKlient.UzytkownikId, userDto);

                if (userResult.Error != null || userResult.Data == null)
                {
                    // ShowError("Błąd podczas zapisywania uzytkownika: " + userResult.Error);
                    Snackbar.Add("Błąd podczas zapisywania danych klienta: " + userResult.Error);
                    return;
                }
            }
          

            if (_orderDataModel.SerwisantId.HasValue)
            {
                var selectedSerwisant = _serwisanci.FirstOrDefault(s => s.SerwisantId == _orderDataModel.SerwisantId.Value);
                
                if (selectedSerwisant != null)
                {
                    var freshUserResult = await ApiService.UzytkownicyRepo.UzytkownikGet(selectedSerwisant.Uzytkownik.UzytkownikId);
                    var freshUserData = freshUserResult.Data;
                    
                    if (freshUserData != null)
                    {
                        int adresEmailIdSerwisanta = freshUserData.AdresEmailId;
                        
                        if (!string.IsNullOrWhiteSpace(_orderDataModel.EmailSerwisanta))
                        {
                            var emailDto = new AdresEmailDto { Email = _orderDataModel.EmailSerwisanta };
                            
                            var emailResult = adresEmailIdSerwisanta > 0
                                ? await ApiService.AdresyEmailRepo.AdresEmailPut(adresEmailIdSerwisanta, emailDto)
                                : await ApiService.AdresyEmailRepo.AdresEmailPost(emailDto);
                            
                            if (emailResult.Error != null)
                            {
                                ShowError("Błąd podczas zapisywania adresu email serwisanta: " + emailResult.Error);
                                return;
                            }
                            
                            adresEmailIdSerwisanta = emailResult.Data?.AdresEmailId ?? 0;
                        }
                        
                        int? numerTelefonuIdSerwisanta = freshUserData.NumerTelefonuId;
                        
                        if (!string.IsNullOrWhiteSpace(_orderDataModel.NumerTelefonuSerwisanta))
                        {
                            var phoneDto = new NumerTelefonuDto { Numer = _orderDataModel.NumerTelefonuSerwisanta };
                            
                            var phoneResult = numerTelefonuIdSerwisanta.HasValue && numerTelefonuIdSerwisanta.Value > 0
                                ? await ApiService.NumeryTelefonuRepo.NumerTelefonuPut(numerTelefonuIdSerwisanta.Value, phoneDto)
                                : await ApiService.NumeryTelefonuRepo.NumerTelefonuPost(phoneDto);
                            
                            if (phoneResult.Error != null)
                            {
                                ShowError("Błąd podczas zapisywania numeru telefonu serwisanta: " + phoneResult.Error);
                                return;
                            }
                            
                            numerTelefonuIdSerwisanta = phoneResult.Data?.NumerTelefonuId;
                        }
                        
                        var userDto = new UzytkownikDto
                        {
                            RolaUzytkownikaId = freshUserData.RolaUzytkownika.RolaUzytkownikaId,
                            Imie = freshUserData.Imie,
                            Nazwisko = freshUserData.Nazwisko,
                            AdresEmailId = adresEmailIdSerwisanta,
                            NumerTelefonuId = numerTelefonuIdSerwisanta,
                            CzyAktywny = freshUserData.CzyAktywny,
                            AdresId = freshUserData.Adres?.AdresId ?? 0
                        };
                        
                        var userResult = await ApiService.UzytkownicyRepo.UzytkownikPut(freshUserData.UzytkownikId, userDto);
                        
                        if (userResult.Error != null || userResult.Data == null)
                        {
                            Snackbar.Add("Błąd podczas zapisywania danych serwisanta: " + userResult.Error, Severity.Error);
                            return;
                        }
                    }
                }
            }
            
            
            var zamowienieDto = new ZamowienieDto
            {
                SerwisantId = _orderDataModel.SerwisantId,
                KlientId = _orderDataModel.KlientId,
                SerwisId = _orderDataModel.SerwisId,
                StatusId = _orderDataModel.StatusId,
                PriorytetId = _orderDataModel.PriorytetId,
                MetodaPlatnosciId = _orderDataModel.MetodaPlatnosciId,
                KomentarzeIds = _orderDataModel.KomentarzeIds,
                NumerTelefonuId = numerTelefonuId,
                AdresEmailId = adresEmailId,
                Koszt100 = _orderDataModel.Koszt100,
                Opis = _orderDataModel.Opis,
                AdresId = addressId,
                PlanowanaDataRealizacjiOd = _orderDataModel.PlanowanaDataRealizacjiOd,
                PlanowanaDataRealizacjiDo = _orderDataModel.PlanowanaDataRealizacjiDo,
                ZrealizowanaDataRealizacjiOd = _orderDataModel.ZrealizowanaDataRealizacjiOd,
                ZrealizowanaDataRealizacjiDo = _orderDataModel.ZrealizowanaDataRealizacjiDo
            };

            var result = await ApiService.ZamowieniaRepo.ZamowieniePut(OrderId, zamowienieDto);

            if (result.Data != null)
            {
                var logDto = new LogDto
                    {
                        ZamowienieId = OrderId,
                        StatusId = _orderDataModel.StatusId,
                        Komentarz = "Aktualizacja danych zlecenia"
                    };

                await ApiService.LogiRepo.LogPost(logDto);

                Snackbar.Add("Zapisano zmiany", Severity.Success);
            //     _orderDataModel = result.Data; Update the _orderDataModel with latest data
            //     await GenerateOrderHistory(); Refresh history
            }
            else
            {
                Snackbar.Add($"Błąd: {result.Error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Wystąpił błąd: {ex.Message}", Severity.Error);
        }
    }

    private void ShowSuccess(string message)
    {
        _message = message;
        _messageClass = "success-message";
    }

    private void ShowError(string error)
    {
        _message = error;
        _messageClass = "error-message";
    }

    private string FormatDate(DateTime? date)
    {
        return date?.ToString("dd.MM.yyyy HH:mm") ?? "Nie określono";
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Zakończony" => "status-finished",
            "W realizacji" => "status-realization",
            "Anulowany" => "status-canceled",
            "Oczekujący" => "status-waiting",
            "Nowy" => "status-new",
            _ => "status-default"
        };
    }
    private string GetSelectedStatusName()
    {
        return _statusy.FirstOrDefault(s => s.StatusId == _orderDataModel.StatusId)?.Nazwa ?? "";
    }
    
    private string GetUserRole()
    {
        if (_uzytkownikZalogowany?.RolaUzytkownika == null)
            return "Brak roli";

        return _uzytkownikZalogowany.RolaUzytkownika.Nazwa;
    }


    public class OrderDataModel
    {
        public int ZamowienieId { get; set; }
        public int? SerwisantId { get; set; }
        public int KlientId { get; set; }
        public int SerwisId { get; set; }
        public int StatusId { get; set; }
        public int PriorytetId { get; set; }
        public int MetodaPlatnosciId { get; set; }
        public List<int>? KomentarzeIds { get; set; }
        public int? NumerTelefonuId { get; set; }
        public int? AdresEmailId { get; set; }
        public int? AdresId { get; set; }
        public int Koszt100 { get; set; }
        public String Opis { get; set; }
        public DateTime? DataAktualizacji { get; set; }
        public DateTime DataDodania { get; set; }
        public DateTime? PlanowanaDataRealizacjiOd { get; set; }
        public DateTime? PlanowanaDataRealizacjiDo { get; set; }
        public DateTime? ZrealizowanaDataRealizacjiOd { get; set; }
        public DateTime? ZrealizowanaDataRealizacjiDo { get; set; }
        public DicStatus Status { get; set; }


        [EmailAddress(ErrorMessage = "Proszę podać poprawny adres email")]
        public string? EmailKlienta { get; set; }

        [RegularExpression(@"^\d{9}$", ErrorMessage = "Numer telefonu powinien składać się z 9 cyfr")]
        public string? NumerTelefonuKlienta { get; set; }

        [EmailAddress(ErrorMessage = "Proszę podać poprawny adres email")]
        public string? EmailSerwisanta { get; set; }

        [RegularExpression(@"^\d{9}$", ErrorMessage = "Numer telefonu powinien składać się z 9 cyfr")]
        public string? NumerTelefonuSerwisanta { get; set; }

        public string? ImieKlienta { get; set; }
        public string? NazwiskoKlienta { get; set; }

        public string? Ulica { get; set; }
        public int NumerDomu { get; set; }
        public int? NumerMieszkania { get; set; }
        public string? KodPocztowy { get; set; }
        public string? Miasto { get; set; }
        public string? Kraj { get; set; }
    }

}
