@page "/bank/typy-oceny"
@rendermode InteractiveServer
@using ApiService
@using ApiService.Models
@using serwis_web.Components
@using Colors = DesignSystem.Tokens.Colors
@using Size = MudBlazor.Size
@inject ISnackbar Snackbar
@inject ApiService ApiService
@inject IDialogService DialogService

<PageTitle>Typy oceny</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudCard Elevation="3" Class="mb-4">
        <MudCardHeader>
            <MudText Typo="Typo.h5">Typy oceny</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" Style="@($"background-color: {Colors.Primary}; color: {Colors.White}")"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@(() => OpenDialog(new DicTypOcenyDto()))">Dodaj typ oceny</MudButton>
        </MudCardHeader>
    </MudCard>

    <MudTable Items="@_typyOceny" Hover="true" Loading="@_loading"
              LoadingProgressColor="@MudBlazor.Color.Info" Style="@($"--mud-palette-primary: {Colors.Primary}")"
              Filter="new Func<DicTypOceny,bool>(FilterFunc)">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Lista typów oceny</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Placeholder="Szukaj" Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"
                          Immediate="true" OnDebounceIntervalElapsed="StateHasChanged"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object>(x => x.TypOcenyId)">ID</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object>(x => x.Ocena)">Ocena</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object>(x => x.Nazwa)">Nazwa</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object?>(x => x.Opis)">Opis</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object>(x => x.DataDodania)">Data utworzenia</MudTableSortLabel></MudTh>
            <MudTh><MudTableSortLabel SortBy="new Func<DicTypOceny, object?>(x => x.DataAktualizacji)">Aktualizacja</MudTableSortLabel></MudTh>
            <MudTh>Akcje</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">@context.TypOcenyId</MudTd>
            <MudTd DataLabel="Ocena">@context.Ocena</MudTd>
            <MudTd DataLabel="Nazwa">@context.Nazwa</MudTd>
            <MudTd DataLabel="Opis">@context.Opis</MudTd>
            <MudTd DataLabel="Data utworzenia">@context.DataDodania.ToString("dd/MM/yyyy")</MudTd>
            <MudTd DataLabel="Aktualizacja">@(context.DataAktualizacji?.ToString("dd/MM/yyyy") ?? "-")</MudTd>
            <MudTd>
                <MudButtonGroup Size="Size.Small" Variant="Variant.Outlined">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Style="@($"color: {Colors.Primary}")"
                                   OnClick="@(() => OpenDialog(MapToDto(context)))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Style="@($"color: {Colors.DarkGray}")"
                                   OnClick="@(() => DeleteConfirm(context.TypOcenyId))" />
                </MudButtonGroup>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager RowsPerPageString="Wierszy na stronę" InfoFormat="{first_item}-{last_item} z {all_items}" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>Nie znaleziono typów oceny</MudText>
        </NoRecordsContent>
    </MudTable>
</MudContainer>

@code {
    private List<DicTypOceny> _typyOceny = new();
    private string _searchString = "";
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        StateHasChanged();
        var result = await ApiService.TypyOcenyRepo.TypyOcenyGet();
        if (result.Data != null)
        {
            _typyOceny = result.Data;
        }
        else
        {
            Snackbar.Add("Błąd podczas pobierania danych: " + result.Error, Severity.Error);
        }
        _loading = false;
        StateHasChanged();
    }

    private bool FilterFunc(DicTypOceny element)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (element.Nazwa.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (element.Opis != null && element.Opis.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        
        if (element.Ocena.ToString().Contains(_searchString))
            return true;

        return false;
    }

    private async Task OpenDialog(DicTypOcenyDto typOceny)
    {
        StateHasChanged();
        var currentId = string.IsNullOrEmpty(typOceny.Nazwa) ? 0 : GetIdFromTypOceny(typOceny);

        var parameters = new DialogParameters
        {
            ["TypOceny"] = typOceny,
            ["IsNew"] = currentId == 0
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var title = currentId > 0 ? "Edytuj typ oceny" : "Dodaj nowy typ oceny";

        var dialog = await DialogService.ShowAsync<TypOcenyDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            if (result.Data is DicTypOcenyDto updatedTypOceny)
            {
                if (currentId > 0)
                {
                    var updateResult = await ApiService.TypyOcenyRepo.TypOcenyPut(currentId, updatedTypOceny);
                    if (updateResult.Data != null)
                    {
                        Snackbar.Add("Typ oceny został zaktualizowany", Severity.Success);
                    }
                    else
                    {
                        Snackbar.Add("Błąd: " + updateResult.Error, Severity.Error);
                    }
                }
                else
                {
                    var createResult = await ApiService.TypyOcenyRepo.TypOcenyPost(updatedTypOceny);
                    if (createResult.Data != null)
                    {
                        Snackbar.Add("Typ oceny został dodany", Severity.Success);
                    }
                    else
                    {
                        Snackbar.Add("Błąd: " + createResult.Error, Severity.Error);
                    }
                }
                await LoadData();
            }
        }
    }

    private int GetIdFromTypOceny(DicTypOcenyDto typOceny)
    {
        var existingRecord = _typyOceny.FirstOrDefault(t =>
            t.Nazwa == typOceny.Nazwa &&
            t.Ocena == typOceny.Ocena &&
            t.Opis == typOceny.Opis);

        return existingRecord?.TypOcenyId ?? 0;
    }

    private async Task DeleteConfirm(int id)
    {
        StateHasChanged();
        var parameters = new DialogParameters
        {
            ["ContentText"] = "Czy na pewno chcesz usunąć ten typ oceny?"
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraSmall
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Potwierdź usunięcie", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await DeleteTypOceny(id);
        }
    }

    private async Task DeleteTypOceny(int id)
    {
        var result = await ApiService.TypyOcenyRepo.TypOcenyDelete(id);
        if (result.Data)
        {
            Snackbar.Add("Typ oceny został usunięty", Severity.Success);
            await LoadData();
        }
        else
        {
            Snackbar.Add("Błąd podczas usuwania: " + result.Error, Severity.Error);
        }
    }

    private DicTypOcenyDto MapToDto(DicTypOceny model)
    {
        return new DicTypOcenyDto
        {
            Ocena = model.Ocena,
            Nazwa = model.Nazwa,
            Opis = model.Opis
        };
    }
}