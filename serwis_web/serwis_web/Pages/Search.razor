@page "/search"
@using ApiService
@using ApiService.Models
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size
@using serwis_web.Components
@inject ApiService ApiService
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Wyniki wyszukiwania</PageTitle>

<div class="services-container">
    <h2>Wyniki wyszukiwania: @searchQuery</h2>

    <div class="service-back">
        @if (isLoading)
        {
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
        }
        else
        {
            @if (showNoResults)
            {
                <div class="no-results">
                    <i class="fa-solid fa-search fa-3x"></i>
                    <h3>Brak wyników dla zapytania "@searchQuery"</h3>
                    <p>Spróbuj użyć innych słów kluczowych.</p>
                </div>
            }
            else
            {
                <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
                    @if (!isKlient && !isSerwisant)
                    {
                        <MudTabPanel Text="@($"Użytkownicy ({users.Count})")" Icon="@Icons.Material.Filled.Person">
                            @if (users.Any())
                            {
                                <div class="search-results">
                                    @foreach (var user in GetPagedUsers())
                                    {
                                        <MudCard Elevation="2" Class="my-2">
                                            <MudCardContent>
                                                <div class="d-flex gap-4">
                                                    <MudAvatar Color="Color.Primary">@(user.Imie?.Length > 0 ? user.Imie[0] : ' ')@(user.Nazwisko?.Length > 0 ? user.Nazwisko[0] : ' ')</MudAvatar>
                                                    <div>
                                                        <MudText Typo="Typo.h6">@user.Imie @user.Nazwisko</MudText>
                                                        <MudText Typo="Typo.body2">@(user.AdresEmail?.Email ?? "")</MudText>
                                                    </div>
                                                </div>
                                            </MudCardContent>
                                            <MudCardActions>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary"
                                                           Href="@($"/users/{user.UzytkownikId}")">
                                                    Szczegóły
                                                </MudButton>
                                            </MudCardActions>
                                        </MudCard>
                                    }
                                </div>
                                
                                @if (users.Count > pageSize)
                                {
                                    <div class="d-flex justify-center mt-4">
                                        <MudPagination 
                                            Count="@GetTotalPages(users.Count)" 
                                            Selected="@currentUsersPage" 
                                            SelectedChanged="@((int page) => OnUsersPageChanged(page))"
                                            Color="Color.Primary"
                                            Variant="Variant.Filled"
                                            Size="Size.Medium" />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-results">
                                    <p>Brak pasujących użytkowników.</p>
                                </div>
                            }
                        </MudTabPanel>
                    }
                    
                    <MudTabPanel Text="@($"Zamówienia ({orders.Count})")" Icon="@Icons.Material.Filled.ShoppingCart">
                        @if (orders.Any())
                        {
                            <div class="search-results">
                                @foreach (var order in GetPagedOrders())
                                {
                                    <MudCard Elevation="2" Class="my-2">
                                        <MudCardContent>
                                            <MudText Typo="Typo.h6">Zamówienie #@order.ZamowienieId</MudText>
                                            <MudText Typo="Typo.body2">Status: @(order.Status?.Nazwa ?? "Nieznany")</MudText>
                                            @if (order.DataDodania != default)
                                            {
                                                <MudText Typo="Typo.body2">Data utworzenia: @order.DataDodania.ToString("dd.MM.yyyy")</MudText>
                                            }
                                            @if (order.Klient != null)
                                            {
                                                <MudText Typo="Typo.body2">Klient: @order.Klient.Uzytkownik?.Imie @order.Klient.Uzytkownik?.Nazwisko</MudText>
                                            }
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Variant="Variant.Text" Color="Color.Primary"
                                                       Href="@($"/orders/{order.ZamowienieId}")">
                                                Szczegóły
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                }
                            </div>
                            
                            @if (orders.Count > pageSize)
                            {
                                <div class="d-flex justify-center mt-4">
                                    <MudPagination 
                                        Count="@GetTotalPages(orders.Count)" 
                                        Selected="@currentOrdersPage" 
                                        SelectedChanged="@((int page) => OnOrdersPageChanged(page))"
                                        Color="Color.Primary"
                                        Variant="Variant.Filled"
                                        Size="Size.Medium" />
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-results">
                                <p>Brak pasujących zamówień.</p>
                            </div>
                        }
                    </MudTabPanel>
                    
                    @if (!isKlient)
                    {
                        <MudTabPanel Text="@($"Usługi ({services.Count})")" Icon="@Icons.Material.Filled.Build">
                            @if (services.Any())
                            {
                                <div class="search-results">
                                    @foreach (var service in GetPagedServices())
                                    {
                                        <MudCard Elevation="2" Class="my-2">
                                            <MudCardContent>
                                                <MudText Typo="Typo.h6">@service.Nazwa</MudText>
                                                <MudText Typo="Typo.subtitle1">Serwis #@service.TypSerwisuId</MudText>
                                                <MudText Typo="Typo.body2">Opis: @service.Opis</MudText>
                                                <MudText Typo="Typo.body2">
                                                    Dodano: @service.DataDodania.ToString("dd.MM.yyyy")
                                                </MudText>
                                            </MudCardContent>
                                            <MudCardActions>
                                                <MudButton Variant="Variant.Text" Color="Color.Primary"
                                                           Href="@($"/services/{service.TypSerwisuId}")">
                                                    Szczegóły
                                                </MudButton>
                                            </MudCardActions>
                                        </MudCard>
                                    }
                                </div>
                                
                                @if (services.Count > pageSize)
                                {
                                    <div class="d-flex justify-center mt-4">
                                        <MudPagination 
                                            Count="@GetTotalPages(services.Count)" 
                                            Selected="@currentServicesPage" 
                                            SelectedChanged="@((int page) => OnServicesPageChanged(page))"
                                            Color="Color.Primary"
                                            Variant="Variant.Filled"
                                            Size="Size.Medium" />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-results">
                                    <p>Brak pasujących serwisów.</p>
                                </div>
                            }
                        </MudTabPanel>
                    }
                </MudTabs>
            }
        }
    </div>
</div>

@* <div class="help-button-container"> *@
@*     <AccessibilityWidget/> *@
@* </div> *@


@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "q")]
    public string? searchQuery { get; set; }

    private bool isLoading = true;
    private bool showNoResults = false;
    private List<Uzytkownik> users = new();
    private List<Zamowienie> orders = new();
    private List<DicTypSerwisu> services = new();
    private Uzytkownik? currentUser;
    private bool isSerwisant = false;
    private bool isKlient = false;
    private int? serwisantId = null;
    private int? klientId = null;

    private const int pageSize = 10;
    private int currentUsersPage = 1;
    private int currentOrdersPage = 1;
    private int currentServicesPage = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentUserAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            isLoading = false;
            showNoResults = true;
            return;
        }

        currentUsersPage = 1;
        currentOrdersPage = 1;
        currentServicesPage = 1;

        await PerformSearch();
    }

    private async Task LoadCurrentUserAsync()
    {
        try
        {
            currentUser = await ApiService.GetUzytkownik();

            if (currentUser.RolaUzytkownika.Nazwa == "Serwisant")
            {
                isSerwisant = true;

                var serwisanci = await ApiService.SerwisanciRepo.SerwisanciGet();
                if (serwisanci.Data != null)
                {
                    var serwisant = serwisanci.Data.FirstOrDefault(s => s.UzytkownikId == currentUser.UzytkownikId);
                    if (serwisant != null)
                    {
                        serwisantId = serwisant.SerwisantId;
                    }
                }
            }
            else if (currentUser.RolaUzytkownika.Nazwa == "Klient")
            {
                isKlient = true;

                var klienci = await ApiService.KlienciRepo.KlienciGet();
                if (klienci.Data != null)
                {
                    var klient = klienci.Data.FirstOrDefault(k => k.UzytkownikId == currentUser.UzytkownikId);
                    if (klient != null)
                    {
                        klientId = klient.KlientId;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd podczas pobierania danych użytkownika.", Severity.Error);
        }
    }

    private async Task PerformSearch()
    {
        isLoading = true;
        showNoResults = false;

        try
        {
            var searchTerms = searchQuery.ToLower().Split(' ', StringSplitOptions.RemoveEmptyEntries);

            var usersResult = await ApiService.UzytkownicyRepo.UzytkownicyGet();
            var ordersResult = await ApiService.ZamowieniaRepo.ZamowieniaGet();
            var servicesResult = await ApiService.TypySerwisuRepo.TypySerwisuGet();

            if (usersResult.Data != null)
            {
                users = usersResult.Data.Where(u =>
                    searchTerms.Any(term =>
                        (u.Imie != null && u.Imie.ToLower().Contains(term)) ||
                        (u.Nazwisko != null && u.Nazwisko.ToLower().Contains(term)) ||
                        (u.AdresEmail != null && u.AdresEmail.Email != null && u.AdresEmail.Email.ToLower().Contains(term)) ||
                        u.UzytkownikId.ToString() == term
                    )
                ).ToList();
            }

            if (ordersResult.Data != null)
            {
                var filteredOrders = ordersResult.Data;
                
                if (isSerwisant && serwisantId.HasValue)
                {
                    filteredOrders = filteredOrders.Where(o => o.SerwisantId == serwisantId.Value).ToList();
                }
                else if (isKlient)
                {
                    filteredOrders = filteredOrders.Where(o => o.KlientId == currentUser!.UzytkownikId).ToList();
                }
                
                orders = filteredOrders.Where(o =>
                    searchTerms.Any(term =>
                        o.ZamowienieId.ToString() == term ||
                        (o.Status != null && o.Status.Nazwa != null && o.Status.Nazwa.ToLower().Contains(term)) ||
                        (o.Klient != null && o.Klient.Uzytkownik != null &&
                         ((o.Klient.Uzytkownik.Imie != null && o.Klient.Uzytkownik.Imie.ToLower().Contains(term)) ||
                          (o.Klient.Uzytkownik.Nazwisko != null && o.Klient.Uzytkownik.Nazwisko.ToLower().Contains(term))))
                    )
                ).ToList();
            }

            if (servicesResult.Data != null)
            {
                services = servicesResult.Data.Where(s =>
                    searchTerms.Any(term =>
                        s.TypSerwisuId.ToString() == term ||
                        (s.Nazwa != null && s.Nazwa.ToLower().Contains(term)) ||
                        (s.Opis != null && s.Opis.ToLower().Contains(term))
                    )
                ).ToList();
            }

            showNoResults = !users.Any() && !orders.Any() && !services.Any();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Błąd podczas wyszukiwania.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private int GetTotalPages(int totalItems)
    {
        return (int)Math.Ceiling((double)totalItems / pageSize);
    }

    private List<Uzytkownik> GetPagedUsers()
    {
        return users.Skip((currentUsersPage - 1) * pageSize)
                   .Take(pageSize)
                   .ToList();
    }

    private List<Zamowienie> GetPagedOrders()
    {
        return orders.Skip((currentOrdersPage - 1) * pageSize)
                    .Take(pageSize)
                    .ToList();
    }

    private List<DicTypSerwisu> GetPagedServices()
    {
        return services.Skip((currentServicesPage - 1) * pageSize)
                      .Take(pageSize)
                      .ToList();
    }

    private async Task OnUsersPageChanged(int page)
    {
        currentUsersPage = page;
        StateHasChanged();
    }

    private async Task OnOrdersPageChanged(int page)
    {
        currentOrdersPage = page;
        StateHasChanged();
    }

    private async Task OnServicesPageChanged(int page)
    {
        currentServicesPage = page;
        StateHasChanged();
    }
}