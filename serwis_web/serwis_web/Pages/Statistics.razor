@page "/statistics"
@rendermode InteractiveServer
@inject ApiService.ApiService ApiService
@using System.Linq
@using Color = MudBlazor.Color
@using Size = MudBlazor.Size

<PageTitle>Statystyki</PageTitle>

<h2>Statystyki serwisu</h2>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4">
    <MudCard Elevation="3" Class="mb-6">
        <MudCardContent>
            @if (_isLoading)
            {
                <div class="d-flex justify-center flex-column align-center py-12">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
                    <MudText Typo="Typo.body1" Class="mt-4">Ładowanie danych statystycznych...</MudText>
                </div>
            }
            else
            {
                <MudGrid>
                    @foreach (var card in _statusCards)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="2">
                            <MudPaper Elevation="2" Class="pa-4 d-flex flex-column align-center">
                                <MudText Typo="Typo.h3">@card.Count</MudText>
                                <MudText Typo="Typo.subtitle1">@card.Label</MudText>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>

                <MudDivider Class="my-6" />

                <MudExpansionPanels Elevation="0" Multiple="true" DisableBorders="true" Class="mt-4">
                    <MudExpansionPanel IsExpanded="true" 
                                       Icon="@Icons.Material.Filled.PieChart" 
                                       Text="Zamówienia według statusu">
                        <MudPaper Elevation="0" Class="pa-4 d-flex justify-center">
                            <MudChart ChartType="ChartType.Pie" 
                                     Width="400px" 
                                     Height="300px" 
                                     InputData="@_orderStatusData" 
                                     InputLabels="@_orderStatusLabels" 
                                     LegendPosition="Position.Bottom" />
                        </MudPaper>
                    </MudExpansionPanel>

                    <MudExpansionPanel 
                        Icon="@Icons.Material.Filled.BarChart" 
                        Text="Obciążenie serwisantów">
                        <MudPaper Elevation="0" Class="pa-4 d-flex justify-center">
                            <MudChart ChartType="ChartType.Bar" 
                                     Width="100%" 
                                     Height="300px" 
                                     ChartSeries="@_technicianWorkloadSeries" 
                                     XAxisLabels="@_technicianNames" />
                        </MudPaper>
                    </MudExpansionPanel>

                    <MudExpansionPanel 
                        Icon="@Icons.Material.Filled.Timeline" 
                        Text="Zamówienia w czasie">
                        <MudPaper Elevation="0" Class="pa-4">
                            <MudChart ChartType="ChartType.Line" 
                                     ChartSeries="@_monthlySeries" 
                                     XAxisLabels="@_monthLabels" 
                                     Width="100%" 
                                     Height="350px" />
                        </MudPaper>
                    </MudExpansionPanel>

                    <MudExpansionPanel 
                        Icon="@Icons.Material.Filled.AccessTime" 
                        Text="Średni czas realizacji zamówień">
                        <MudPaper Elevation="0" Class="pa-4 d-flex justify-center">
                            <MudChart ChartType="ChartType.Donut" 
                                     Width="350px" 
                                     Height="350px" 
                                     InputData="@_avgTimeData" 
                                     InputLabels="@_avgTimeLabels" 
                                     LegendPosition="Position.Right" />
                        </MudPaper>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private double[] _orderStatusData = Array.Empty<double>();
    private string[] _orderStatusLabels = Array.Empty<string>();
    private List<ChartSeries> _technicianWorkloadSeries = new();
    private string[] _technicianNames = Array.Empty<string>();
    private List<ChartSeries> _monthlySeries = new();
    private string[] _monthLabels = { "Sty", "Lut", "Mar", "Kwi", "Maj", "Cze", "Lip", "Sie", "Wrz", "Paź", "Lis", "Gru" };
    private List<StatusCard> _statusCards = new();
    private bool _isLoading = true;
    
    private double[] _avgTimeData = { 3.5, 5.2, 7.1, 12.4 };
    private string[] _avgTimeLabels = { "Naprawa sprzętu", "Konserwacja", "Instalacja", "Diagnostyka" };
    
    private List<ChartSeries> _yearlyComparisonSeries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        InitializeAdditionalCharts();
    }

    private void InitializeAdditionalCharts()
    {
        _yearlyComparisonSeries = new List<ChartSeries>
        {
            new ChartSeries() { 
                Name = "2024", 
                Data = new double[] { 42, 38, 55, 67, 73, 80, 95, 92, 85, 77, 63, 58 }, 
                ShowDataMarkers = false
            },
            new ChartSeries() { 
                Name = "2023", 
                Data = new double[] { 35, 32, 48, 55, 65, 70, 82, 78, 70, 65, 52, 48 }, 
                ShowDataMarkers = false
            }
        };
    }

    private async Task LoadData()
    {
        try
        {
            _isLoading = true;

            await Task.WhenAll(
                LoadOrderStatusData(),
                LoadTechnicianWorkloadData(),
                LoadMonthlyOrderData()
            );
        }
        catch (Exception ex)
        {
            System.Console.WriteLine($"Error loading statistics: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadOrderStatusData()
    {
        var statusesResult = await ApiService.StatusyRepo.StatusyGet();
        var ordersResult = await ApiService.ZamowieniaRepo.ZamowieniaGet();

        if (statusesResult.Data != null && ordersResult.Data != null)
        {
            var statusGroups = ordersResult.Data
                .GroupBy(z => z.StatusId)
                .Select(g => new { StatusId = g.Key, Count = g.Count() })
                .ToList();

            var statusLabels = new List<string>();
            var statusData = new List<double>();
            var statusCards = new List<StatusCard>();

            foreach (var status in statusesResult.Data)
            {
                var count = statusGroups.FirstOrDefault(g => g.StatusId == status.StatusId)?.Count ?? 0;
                
                statusLabels.Add(status.Nazwa);
                statusData.Add(count);
                
                string cssClass = status.Nazwa switch
                {
                    "Nowe" => "status-new mud-primary-lighten-1",
                    "W trakcie realizacji" => "status-realization mud-info-lighten-1",
                    "Oczekujące" => "status-waiting mud-warning-lighten-1",
                    "Zakończone" => "status-finished mud-success-lighten-1",
                    "Anulowane" => "status-canceled mud-error-lighten-1",
                    _ => "status-default"
                };

                statusCards.Add(new StatusCard
                {
                    Label = status.Nazwa,
                    Count = count,
                    CssClass = cssClass
                });
            }

            _orderStatusLabels = statusLabels.ToArray();
            _orderStatusData = statusData.ToArray();
            _statusCards = statusCards;
        }
    }

    private async Task LoadTechnicianWorkloadData()
    {
        var serwisanciResult = await ApiService.SerwisanciRepo.SerwisanciGet();
        var ordersResult = await ApiService.ZamowieniaRepo.ZamowieniaGet();

        if (serwisanciResult.Data != null && ordersResult.Data != null)
        {
            var technicianWorkload = serwisanciResult.Data
                .Take(5) 
                .Select(s => {
                    var assignedOrders = ordersResult.Data.Count(order => order.SerwisantId == s.SerwisantId);
                    return new { 
                        Name = $"{s.Uzytkownik?.Imie?.FirstOrDefault() ?? '?'}.{s.Uzytkownik?.Nazwisko ?? "?"}",
                        AssignedCount = assignedOrders 
                    };
                })
                .OrderByDescending(t => t.AssignedCount)
                .ToList();

            _technicianNames = technicianWorkload.Select(t => t.Name).ToArray();
            _technicianWorkloadSeries = new List<ChartSeries>
            {
                new ChartSeries() { 
                    Name = "Przypisane zamówienia", 
                    Data = technicianWorkload.Select(t => (double)t.AssignedCount).ToArray(), 
                    ShowDataMarkers = true 
                }
            };
        }
    }

    private async Task LoadMonthlyOrderData()
    {
        var ordersResult = await ApiService.ZamowieniaRepo.ZamowieniaGet();

        if (ordersResult.Data != null)
        {
            var currentYear = DateTime.Now.Year;
            var monthlyNewOrders = new double[12];
            var monthlyCompletedOrders = new double[12];

            foreach (var order in ordersResult.Data)
            {
                if (order.DataDodania.Year == currentYear)
                {
                    int month = order.DataDodania.Month - 1;
                    monthlyNewOrders[month]++;
                }

                if (order.Status?.Nazwa == "Zakończone" && order.DataAktualizacji?.Year == currentYear)
                {
                    int month = order.DataAktualizacji.Value.Month - 1;
                    monthlyCompletedOrders[month]++;
                }
            }

            _monthlySeries = new List<ChartSeries>
            {
                new ChartSeries() { 
                    Name = "Nowe zamówienia", 
                    Data = monthlyNewOrders, 
                    ShowDataMarkers = true 
                },
                new ChartSeries() { 
                    Name = "Zakończone", 
                    Data = monthlyCompletedOrders, 
                    ShowDataMarkers = true 
                }
            };
        }
    }

    private class StatusCard
    {
        public string Label { get; set; } = string.Empty;
        public double Count { get; set; }
        public string CssClass { get; set; } = "status-default";
    }
}
