@page "/users"
@rendermode InteractiveServer
@using ApiService
@using ApiService.Models
@using serwis_web.Components
@using Color = MudBlazor.Color
@using DialogService = MudBlazor.DialogService
@using Placement = MudBlazor.Placement
@using Size = MudBlazor.Size
@inject ApiService ApiService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Użytkownicy</PageTitle>

<style>
    .order-container {
        margin: 0;
        padding: 0;
        min-width: 100%;
        border: none;
    }

    .order-header {
        margin: 0 0 10px 0;
        padding: 0;
    }

    .order-header-tittle {
        font-size: 30px;
        font-weight: 600
    }

    .order-header-search-button {
        margin: 0 0 25px 0;
        padding: 0 40px 0 0;
        width: 100%;
        justify-content: space-between
    }

    .order-search {
        max-width: 300px;
    }

    .new-button {
        background-color: #4880FF;
        border: none;
        border-radius: 10px;
        padding: 12px 50px;
        color: #FFFFFF;
        font-size: 16px;
        transition: all 0.3s ease-in-out;
        cursor: pointer;
        text-transform: none;
    }

    .new-button:hover {
        background-color: #336ff5;
    }

    .order-grid {
        border-radius: 15px;
        box-shadow: 0 1px 1px 0 rgba(0, 0, 0, 0.1), 0 1px 4px 0 rgba(0, 0, 0, 0.1);
    }

    .order-category {
        font-size: 16px;
        font-weight: 500;
        text-align: center;
        background-color: #FCFDFD !important;
        border-top-left-radius: 15px !important;
        border-top-right-radius: 15px !important;
        border-bottom: solid 2px #efefef !important;
    }

    .order-category-left {
        font-size: 16px;
        font-weight: 500;
        padding: 10px;
        margin: 0;
        text-align: center;
        background-color: #FCFDFD !important;
        border-top-left-radius: 15px !important;
        border-top-right-radius: 15px !important;
        border-bottom: solid 2px #efefef !important;
    }

    .order-category-right {
        font-size: 16px;
        font-weight: 500;
        padding: 14px 10px;
        margin: 0;
        text-align: center;
        background-color: #f1f4f9 !important;
        border: none;
        border-top-right-radius: 15px !important;
        border-bottom-right-radius: 15px !important;
    }

    .order-category-single-item {
        font-size: 16px;
        font-weight: 500;
        text-decoration: none;
    }

    .order-category-single-item-id {
        font-size: 16px;
        font-weight: 500;
        text-decoration: none !important;
        color: #000000 !important;
    }

    .status-finished {
        background-color: #d0f0e4;
        color: #0d8a5f;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    .status-realization {
        background-color: #e6e1ff;
        color: #6952e9;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    .status-canceled {
        background-color: #ffd9d9;
        color: #e75757;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    .status-waiting {
        background-color: #ffe9d1;
        color: #e99c52;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    .status-new {
        background-color: #e6e1ff;
        color: #6952e9;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    .status-default {
        background-color: inherit;
        border: none;
        min-width: 75% !important;
        border-radius: 5px !important;
        padding: 18px 12px !important;
        font-weight: 600;
        font-size: 16px;
    }

    @@media (max-width: 1024px) {
        .order-search {
            display: none;
        }

        .new-button {
            width: 100%;
            margin-top: 10px;
        }
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="order-container">
    
    <MudCardHeader Class="order-header">
        <MudText Class="order-header-tittle">Użytkownicy</MudText>
    </MudCardHeader>

    <MudCardHeader Class="order-header-search-button">
        <MudItem>
            <MudTextField @bind-Value="_searchString"
                          Placeholder="Szukaj użytkownika"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Immediate="true"
                          DebounceInterval="500"
                          OnDebounceIntervalElapsed="ApplySearch"
                          Class="order-search"></MudTextField>
        </MudItem>
        <MudButton Class="new-button" OnClick="@(() => NavigateToNewUser())">Dodaj użytkownika</MudButton>
    </MudCardHeader>

    <MudDataGrid T="Uzytkownik" Items="@_filteredUzytkownicy" Hover="true" Loading="@_loading"
                 LoadingProgressColor="Color.Info" Filterable="true"
                 FilterMode="DataGridFilterMode.ColumnFilterMenu"
                 FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
                 FixedHeader="true" Pagination="false" Height="auto"
                 RowsPerPage="7"
                 Bordered="false" Dense="false" Class="order-grid">

        <Columns>
            <PropertyColumn T="Uzytkownik" TProperty="int" Property="x => x.UzytkownikId" Title="ID" HeaderClass="order-category-left">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudLink Href="@($"/users/{context.Item.UzytkownikId}")" Class="order-category-single-item-id">@context.Item.UzytkownikId.ToString("D5")</MudLink>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn T="Uzytkownik" TProperty="string" Property="x => x.Imie" Title="Imię" HeaderClass="order-category">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudText Class="order-category-single-item">@(context.Item.Imie ?? "Nie określono")</MudText>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn T="Uzytkownik" TProperty="string" Property="x => x.Nazwisko" Title="Nazwisko" HeaderClass="order-category">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudText Class="order-category-single-item">@(context.Item.Nazwisko ?? "Nie określono")</MudText>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn T="Uzytkownik" TProperty="string" Property="x => x.AdresEmail.Email" Title="Email" HeaderClass="order-category">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudText Class="order-category-single-item">@context.Item.AdresEmail.Email</MudText>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn T="Uzytkownik" TProperty="string" Property="x => x.NumerTelefonu.Numer" Title="Telefon" HeaderClass="order-category">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudText Class="order-category-single-item">@(context.Item.NumerTelefonu?.Numer ?? "Nie określono")</MudText>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <PropertyColumn T="Uzytkownik" TProperty="DateTime" Property="x => x.DataDodania" Title="Data utworzenia" HeaderClass="order-category">
                <CellTemplate>
                    <MudChip Size="Size.Medium" Class="status-default">
                        <MudText Class="order-category-single-item">@context.Item.DataDodania.ToString("dd MMMM yyyy")</MudText>
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>

            <TemplateColumn HeaderClass="order-category" Title="Akcje">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditUser(context.Item.UzytkownikId))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteUser(context.Item.UzytkownikId))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="Uzytkownik" RowsPerPageString="Wierszy na stronę" InfoFormat="{first_item}-{last_item} z {all_items}" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>Nie znaleziono użytkowników</MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudContainer>

@code {
    private string _searchString = "";
    private bool _loading = true;
    private List<Uzytkownik> _uzytkownicy = new();
    private List<Uzytkownik> _filteredUzytkownicy = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        try
        {
            var result = await ApiService.UzytkownicyRepo.UzytkownicyGet();
            if (result.Data != null)
            {
                _uzytkownicy = result.Data;
                _filteredUzytkownicy = _uzytkownicy;

                if (_uzytkownicy.Count == 0)
                {
                    Snackbar.Add("Nie znaleziono żadnych użytkowników", Severity.Info);
                }
            }
            else
            {
                Snackbar.Add($"Błąd podczas ładowania użytkowników: {result.Error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Wystąpił wyjątek: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ApplySearch()
    {
        if (string.IsNullOrWhiteSpace(_searchString))
        {
            _filteredUzytkownicy = _uzytkownicy;
        }
        else
        {
            string searchLower = _searchString.ToLower();
            _filteredUzytkownicy = _uzytkownicy.Where(u =>
                u.UzytkownikId.ToString().Contains(searchLower) ||
                (u.Imie?.ToLower().Contains(searchLower) == true) ||
                (u.Nazwisko?.ToLower().Contains(searchLower) == true) ||
                u.AdresEmail.Email.ToLower().Contains(searchLower) ||
                (u.NumerTelefonu?.Numer?.ToLower().Contains(searchLower) == true) ||
                u.DataDodania.ToString("dd MMMM yyyy").ToLower().Contains(searchLower)
            ).ToList();
        }

        StateHasChanged();
    }

    private void NavigateToNewUser()
    {
    }

    private void EditUser(int userId)
    {
    }

    private async Task DeleteUser(int id)
    {
        StateHasChanged();
        var parameters = new DialogParameters
        {
            ["ContentText"] = "Czy na pewno chcesz usunąć tego użytkownika?"
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.ExtraSmall
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Potwierdź usunięcie", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
        }
    }
}