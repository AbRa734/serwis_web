@rendermode InteractiveServer
@using ApiService
@using ApiService.Models
@inject ApiService ApiService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<div class="top-section">
    <a class="tab-container" href="/services">
        <div class="tab-wrapper">
            <h3>Nowe zlecenie</h3>
            <p>Utwórz nowe zlecenie serwisowe</p>
            <div class="order-box">
                <i class="fa-solid fa-plus" style="color: #8280FF"></i>
            </div>
        </div>
    </a>

    <a class="tab-container" href="/statistics">
        <div class="tab-wrapper">
            <h3>Statystyki</h3>
            <p>Śledź ilość i status wykonanych zleceń</p>
            <div class="statistics-box">
                <i class="fa-solid fa-chart-simple" style="color: #4AD991"></i>
            </div>
        </div>
    </a>

    <a class="tab-container" href="/report">
        <div class="tab-wrapper">
            <h3>Raport</h3>
            <p>Podsumowanie wykonanych usług</p>
            <div class="report-box">
                <i class="fa-solid fa-file" style="color: #FF9066"></i>
            </div>
        </div>
    </a>
</div>

<div class="add-comment" @onclick="OpenCommentDialog">
    <div class="comment-top">
        <div class="comment-box">
            <i class="fa-regular fa-keyboard" style="color: #BA29FF; font-size: 32px;"></i>
        </div>
        <h3>Dodaj komentarz do usługi</h3>
    </div>
    <p>Podziel się swoją opinią na temat wykonanej usługi, aby ulepszyć jakość naszych usług</p>
</div>

<div class="add-rate" @onclick="OpenRatingDialog">
    <div class="rate-top">
        <div class="rate-box">
            <i class="fa-solid fa-star" style="color: #FEC53D; font-size: 32px;"></i>
        </div>
        <h3>Oceń wykonaną usługę</h3>
    </div>
    <p>Wystaw ocenę, aby wyrazić swoje zadowolenie z realizacji naszych usług</p>
</div>

    

@code {
    private bool _loading = true;
    private List<Zamowienie> _zamowienia = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadServicesAsync();
    }

    private async Task LoadServicesAsync()
    {
        _loading = true;
        try
        {
            var result = await ApiService.ZamowieniaRepo.ZamowieniaGet();
            if (result.Data != null)
            {
                _zamowienia = result.Data;
                
            }
            else
            {
                Snackbar.Add($"Błąd podczas ładowania zleceń.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Wystąpił błąd, spróbuj ponownie później.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCommentDialog()
    {
        var parameters = new DialogParameters
        {
            ["Orders"] = _zamowienia,
            ["CommentText"] = string.Empty,
            ["SelectedOrderId"] = 0
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            Position = DialogPosition.Center
        };

        var dialog = await DialogService.ShowAsync<CommentDialog>("", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var commentResult = (CommentDialog.CommentDialogResult)result.Data;
            try
            {
                // TODO: dodać logikę zapisu komentarza
                // await ApiService.AddComment(commentResult.OrderId, commentResult.Comment);

                Snackbar.Add("Komentarz został dodany pomyślnie", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Błąd podczas dodawania komentarza.", Severity.Error);
            }
        }
    }

    private async Task OpenRatingDialog()
    {
        var parameters = new DialogParameters
        {
            ["Orders"] = _zamowienia,
            ["SelectedOrderId"] = 0,
            ["SelectedRatingValue"] = 0,
            ["RatingComment"] = string.Empty
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            Position = DialogPosition.Center
        };

        var dialog = await DialogService.ShowAsync<RatingDialog>("", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var ratingResult = (RatingDialog.RatingDialogResult)result.Data;
            try
            {
                //TODO: dodać logikę zapisu oceny
                // await ApiService.AddRating(ratingResult.OrderId, ratingResult.Rating, ratingResult.Comment);
                Snackbar.Add("Ocena została dodana pomyślnie", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Błąd podczas dodawania oceny.", Severity.Error);
            }
        }
    }

}